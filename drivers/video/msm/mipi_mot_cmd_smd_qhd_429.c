/* Copyright (c) 2010-2011, Code Aurora Forum. All rights reserved.
 * Copyright (c) 2011, Motorola Mobility, Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
 * only version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 */

#include "msm_fb.h"
#include "mipi_dsi.h"
#include "mipi_mot.h"
#include "mdp4.h"

#define NUMBER_BRIGHTNESS_LEVELS    30
/* 200 nits. Default brightness should be same with it in bootloader */
#define DEFAULT_BRIGHTNESS_LEVELS 19
#define DEFAULT_DELAY 1

static struct mipi_mot_panel *mot_panel;

/* DSI timing calculated for qhd 4.3 based on QCOM table */
static struct mipi_dsi_phy_ctrl dsi_cmd_mode_phy_db = {
	{0x09, 0x08, 0x05, 0x00, 0x20},/* regulator */
	/* timing   */
	{0xb4, 0x2b, 0x1d, 0x00, 0x96, 0x94, 0x21,
	0x2d, 0x21, 0x03, 0x04, 0xa0},
	{0x5f, 0x00, 0x00, 0x10},/* phy ctrl */
	{0xff, 0x00, 0x06, 0x00},/* strength */
	/* pll control */
	{0x0, 0xcb, 0x1, 0x1a, 0x00, 0x50, 0x48, 0x63,
	/* 2 MIPI lanes */
	0x41, 0x0f, 0x03,
	0x00, 0x14, 0x03, 0x00, 0x02, 0x00, 0x20, 0x00, 0x01 },
};

static char enter_sleep[2] = {DCS_CMD_ENTER_SLEEP_MODE, 0x00};
static char display_off[2] = {DCS_CMD_SET_DISPLAY_OFF, 0x00};

static struct dsi_cmd_desc display_off_cmds[] = {
	{DTYPE_DCS_WRITE, 1, 0, 0, 10, sizeof(display_off), display_off},
	{DTYPE_DCS_WRITE, 1, 0, 0, 120, sizeof(enter_sleep), enter_sleep},
};

static char exit_sleep[2] = {DCS_CMD_EXIT_SLEEP_MODE, 0x00};

/* [1] */
static char etc_condition_set1_F0[3] = {0xf0, 0x5a, 0x5a};
static char etc_condition_set1_F1[3] = {0xf1, 0x5a, 0x5a};
static char etc_condition_set1_FC[3] = {0xfc, 0x5a, 0x5a};
static struct dsi_cmd_desc smd_qhd_429_cmds_1[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set1_F0), etc_condition_set1_F0},
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set1_F1), etc_condition_set1_F1},
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set1_FC), etc_condition_set1_FC},
};
/* [2] */
static char def_gamma_settings_nit[NUMBER_BRIGHTNESS_LEVELS][26] = {
	/* 300 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB0, 0xC7, 0xA0, 0xB0, 0xC5,
	 0xB8, 0xC2, 0xCB, 0xC1, 0x94, 0xA0, 0x8F, 0xAD, 0xB3, 0xA6,
	 0x00, 0xE0, 0x00, 0xD7, 0x01, 0x08},
	/* 290 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB0, 0xC7, 0xA0, 0xB2, 0xC6,
	 0xBA, 0xC1, 0xCA, 0xC0, 0x94, 0xA0, 0x8F, 0xAD, 0xB3, 0xA6,
	 0x00, 0xDD, 0x00, 0xD4, 0x01, 0x05},
	/* 280 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB3, 0xCA, 0xA3, 0xB0, 0xC5,
	 0xB7, 0xC0, 0xCA, 0xBF, 0x95, 0xA1, 0x90, 0xAD, 0xB3, 0xA6,
	 0x00, 0xDA, 0x00, 0xD1, 0x01, 0x01},
	/* 270 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAE, 0xC4, 0x9F, 0xAF, 0xC3,
	 0xB5, 0xC1, 0xCB, 0xC0, 0x95, 0xA1, 0x90, 0xAD, 0xB3, 0xA6,
	 0x00, 0xD8, 0x00, 0xCF, 0x00, 0xFE},
	/* 260 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAE, 0xC4, 0x9F, 0xB1, 0xC5,
	 0xB7, 0xC0, 0xCA, 0xC0, 0x96, 0xA2, 0x91, 0xAE, 0xB4, 0xA7,
	 0x00, 0xD4, 0x00, 0xCB, 0x00, 0xF9},
	/* 250 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB2, 0xC7, 0xA3, 0xB0, 0xC4,
	 0xB5, 0xC0, 0xCB, 0xC1, 0x94, 0xA1, 0x90, 0xAF, 0xB5, 0xA8,
	 0x00, 0xD1, 0x00, 0xC8, 0x00, 0xF5},
	/* 240 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB2, 0xC7, 0xA3, 0xB3, 0xC6,
	 0xB7, 0xC0, 0xCB, 0xC0, 0x96, 0xA2, 0x91, 0xAF, 0xB5, 0xA9,
	 0x00, 0xCE, 0x00, 0xC5, 0x00, 0xF2},
	/* 230 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAD, 0xC1, 0x9F, 0xB1, 0xC4,
	 0xB5, 0xC0, 0xCC, 0xC2, 0x95, 0xA2, 0x91, 0xAF, 0xB6, 0xA9,
	 0x00, 0xCB, 0x00, 0xC2, 0x00, 0xEE},
	/* 220 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAD, 0xC1, 0x9F, 0xB4, 0xC6,
	 0xB7, 0xBF, 0xCB, 0xC1, 0x96, 0xA3, 0x92, 0xB0, 0xB7, 0xAA,
	 0x00, 0xC8, 0x00, 0xBF, 0x00, 0xEA},
	/* 210 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB1, 0xC4, 0xA3, 0xB2, 0xC5,
	 0xB5, 0xC0, 0xCD, 0xC2, 0x96, 0xA3, 0x92, 0xB0, 0xB7, 0xAA,
	 0x00, 0xC5, 0x00, 0xBC, 0x00, 0xE6},
	/* 200 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB4, 0xC8, 0xA7, 0xB0, 0xC3,
	 0xB2, 0xBF, 0xCC, 0xC2, 0x97, 0xA4, 0x93, 0xB1, 0xB8, 0xAC,
	 0x00, 0xC1, 0x00, 0xB8, 0x00, 0xE1},
	/* 190 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAC, 0xBE, 0x9F, 0xB3, 0xC5,
	 0xB5, 0xC0, 0xCD, 0xC3, 0x97, 0xA4, 0x93, 0xB2, 0xB9, 0xAD,
	 0x00, 0xBD, 0x00, 0xB5, 0x00, 0xDD},
	/* 180 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB0, 0xC1, 0xA3, 0xB1, 0xC3,
	 0xB2, 0xC1, 0xCF, 0xC5, 0x98, 0xA4, 0x94, 0xB2, 0xB9, 0xAD,
	 0x00, 0xBA, 0x00, 0xB1, 0x00, 0xD8},
	/* 170 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB3, 0xC5, 0xA7, 0xB0, 0xC2,
	 0xAF, 0xC0, 0xCE, 0xC4, 0x99, 0xA6, 0x95, 0xB3, 0xBA, 0xAE,
	 0x00, 0xB6, 0x00, 0xAE, 0x00, 0xD4},
	/* 160 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAA, 0xBA, 0x9F, 0xAE, 0xC0,
	 0xAC, 0xC1, 0xCF, 0xC5, 0x9A, 0xA7, 0x96, 0xB3, 0xBA, 0xAE,
	 0x00, 0xB2, 0x00, 0xAA, 0x00, 0xCF},
	/* 150 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAA, 0xBA, 0x9F, 0xB4, 0xC4,
	 0xB1, 0xBF, 0xCE, 0xC4, 0x99, 0xA6, 0x96, 0xB5, 0xBD, 0xB1,
	 0x00, 0xAE, 0x00, 0xA6, 0x00, 0xCA},
	/* 140 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAE, 0xBD, 0xA3, 0xB2, 0xC2,
	 0xAF, 0xC0, 0xD0, 0xC5, 0x9A, 0xA7, 0x97, 0xB5, 0xBD, 0xB1,
	 0x00, 0xAA, 0x00, 0xA2, 0x00, 0xC5},
	/* 130 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA5, 0xB2, 0x9B, 0xAF, 0xBF,
	 0xAA, 0xC1, 0xD1, 0xC7, 0x9B, 0xA8, 0x98, 0xB6, 0xBE, 0xB2,
	 0x00, 0xA6, 0x00, 0x9E, 0x00, 0xC0},
	/* 120 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xAA, 0xB7, 0xA1, 0xAE, 0xBE,
	 0xA7, 0xBF, 0xD0, 0xC6, 0x9B, 0xA9, 0x98, 0xB7, 0xBF, 0xB4,
	 0x00, 0xA2, 0x00, 0x9A, 0x00, 0xBA},
	/* 110 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xB0, 0xBB, 0xA7, 0xAA, 0xBB,
	 0xA2, 0xC1, 0xD2, 0xC8, 0x9B, 0xA9, 0x99, 0xB9, 0xC1, 0xB5,
	 0x00, 0x9D, 0x00, 0x95, 0x00, 0xB5},
	/* 100 */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xAC, 0x99, 0xB1, 0xC0,
	 0xA8, 0xC3, 0xD3, 0xC9, 0x9A, 0xA9, 0x99, 0xB8, 0xC1, 0xB5,
	 0x00, 0x99, 0x00, 0x91, 0x00, 0xB0},
	/* 90  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA7, 0xB0, 0x9F, 0xAD, 0xBC,
	 0xA3, 0xC5, 0xD5, 0xCB, 0x9B, 0xAB, 0x9B, 0xB9, 0xC1, 0xB5,
	 0x00, 0x94, 0x00, 0x8C, 0x00, 0xAA},
	/* 80  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x97, 0x9F, 0x92, 0xAE, 0xBD,
	 0xA3, 0xC2, 0xD2, 0xC7, 0x9C, 0xAD, 0x9D, 0xBB, 0xC3, 0xB7,
	 0x00, 0x8E, 0x00, 0x87, 0x00, 0xA3},
	/* 70  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xA8, 0x9F, 0xA7, 0xB8,
	 0x9B, 0xC2, 0xD1, 0xC4, 0x9B, 0xAD, 0x9D, 0xBD, 0xC5, 0xB9,
	 0x00, 0x88, 0x00, 0x81, 0x00, 0x9D},
	/* 60  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x92, 0x95, 0x8F, 0xA8, 0xB9,
	 0x9B, 0xC2, 0xD0, 0xC2, 0x9B, 0xAE, 0x9F, 0xBD, 0xC5, 0xB9,
	 0x00, 0x83, 0x00, 0x7C, 0x00, 0x96},
	/* 50  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x98, 0x99, 0x96, 0xA9, 0xBB,
	 0x9C, 0xC2, 0xCF, 0xBF, 0x9C, 0xB1, 0xA1, 0xBD, 0xC6, 0xBA,
	 0x00, 0x7C, 0x00, 0x76, 0x00, 0x8F},
	/* 40  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x8C, 0x8C, 0x8C, 0xA7, 0xB7,
	 0x9A, 0xBF, 0xCB, 0xB8, 0x9C, 0xB3, 0xA3, 0xC0, 0xC9, 0xBE,
	 0x00, 0x74, 0x00, 0x6D, 0x00, 0x85},
	/* 30  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x71, 0x71, 0x71, 0xB1, 0xBE,
	 0xA8, 0xBA, 0xC7, 0xB0, 0x9E, 0xB5, 0xA4, 0xBF, 0xC8, 0xBD,
	 0x00, 0x6C, 0x00, 0x65, 0x00, 0x7B},
	/* 20  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x80, 0x80, 0x80, 0xAD, 0xB4,
	 0xA8, 0xBE, 0xCC, 0xB4, 0x9B, 0xB1, 0x9C, 0xC0, 0xCC, 0xC2,
	 0x00, 0x5F, 0x00, 0x59, 0x00, 0x6D},
	/* 10  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x4C, 0x4C, 0x4C, 0x9B, 0x9B,
	 0x9B, 0xC1, 0xCA, 0xB9, 0x96, 0xAA, 0x8B, 0xBF, 0xD0, 0xC5,
	 0x00, 0x4F, 0x00, 0x49, 0x00, 0x5B}
};

static char greenish_gamma_settings_nit[NUMBER_BRIGHTNESS_LEVELS][26] = {
	/* 300  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9E, 0xBE, 0x9F, 0xB2, 0xC3,
	 0xB8, 0xBF, 0xC8, 0xBD, 0x94, 0xA0, 0x8F, 0xAF, 0xB6, 0xAB,
	 0x00, 0xD8, 0x00, 0xDA, 0x01, 0x01},
	/* 290	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9E, 0xBE, 0x9F, 0xB4, 0xC5,
	 0xBA, 0xBE, 0xC7, 0xBC, 0x94, 0xA0, 0x8F, 0xAF, 0xB6, 0xAB,
	 0x00, 0xD5, 0x00, 0xD7, 0x00, 0xFE},
	/* 280	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xC1, 0xA2, 0xB2, 0xC3,
	 0xB7, 0xBD, 0xC7, 0xBC, 0x95, 0xA1, 0x90, 0xAF, 0xB6, 0xAB,
	 0x00, 0xD3, 0x00, 0xD5, 0x00, 0xFB},
	/* 270	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xBC, 0x9E, 0xB0, 0xC1,
	 0xB5, 0xBE, 0xC8, 0xBD, 0x94, 0xA0, 0x8F, 0xAF, 0xB6, 0xAB,
	 0x00, 0xD0, 0x00, 0xD2, 0x00, 0xF7},
	/* 260	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xBC, 0x9E, 0xB2, 0xC3,
	 0xB7, 0xBD, 0xC7, 0xBC, 0x95, 0xA1, 0x90, 0xAF, 0xB7, 0xAC,
	 0x00, 0xCD, 0x00, 0xCE, 0x00, 0xF3},
	/* 250	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xBF, 0xA2, 0xB0, 0xC1,
	 0xB5, 0xBE, 0xC9, 0xBE, 0x94, 0xA0, 0x8F, 0xB0, 0xB8, 0xAD,
	 0x00, 0xCA, 0x00, 0xCC, 0x00, 0xF0},
	/* 240	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xBF, 0xA2, 0xB2, 0xC3,
	 0xB7, 0xBE, 0xC8, 0xBD, 0x95, 0xA1, 0x90, 0xB1, 0xB8, 0xAD,
	 0x00, 0xC7, 0x00, 0xC9, 0x00, 0xEC},
	/* 230	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xB9, 0x9E, 0xB0, 0xC1,
	 0xB5, 0xBF, 0xC9, 0xBF, 0x94, 0xA1, 0x90, 0xB1, 0xB8, 0xAD,
	 0x00, 0xC4, 0x00, 0xC6, 0x00, 0xE9},
	/* 220	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xB9, 0x9E, 0xB3, 0xC3,
	 0xB7, 0xBE, 0xC9, 0xBE, 0x96, 0xA2, 0x91, 0xB1, 0xB9, 0xAE,
	 0x00, 0xC1, 0x00, 0xC3, 0x00, 0xE5},
	/* 210	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xBD, 0xA2, 0xB0, 0xC2,
	 0xB4, 0xBF, 0xCA, 0xC0, 0x95, 0xA2, 0x90, 0xB1, 0xB9, 0xAE,
	 0x00, 0xBE, 0x00, 0xC0, 0x00, 0xE2},
	/* 200	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA5, 0xC0, 0xA6, 0xAE, 0xC0,
	 0xB2, 0xBE, 0xCA, 0xC0, 0x96, 0xA3, 0x92, 0xB2, 0xBA, 0xAE,
	 0x00, 0xBB, 0x00, 0xBC, 0x00, 0xDD},
	/* 190	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xB7, 0x9E, 0xB0, 0xC2,
	 0xB4, 0xC0, 0xCB, 0xC1, 0x96, 0xA2, 0x91, 0xB3, 0xBB, 0xAF,
	 0x00, 0xB7, 0x00, 0xB9, 0x00, 0xD9},
	/* 180	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xBB, 0xA2, 0xAE, 0xC0,
	 0xB2, 0xC1, 0xCC, 0xC3, 0x96, 0xA3, 0x92, 0xB3, 0xBB, 0xAF,
	 0x00, 0xB4, 0x00, 0xB5, 0x00, 0xD5},
	/* 170	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA5, 0xBE, 0xA6, 0xAB, 0xBE,
	 0xAF, 0xC0, 0xCC, 0xC2, 0x97, 0xA4, 0x93, 0xB4, 0xBB, 0xB0,
	 0x00, 0xB0, 0x00, 0xB2, 0x00, 0xD1},
	/* 160	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xB4, 0x9E, 0xA9, 0xBC,
	 0xAC, 0xC1, 0xCD, 0xC4, 0x98, 0xA5, 0x94, 0xB4, 0xBB, 0xB0,
	 0x00, 0xAD, 0x00, 0xAE, 0x00, 0xCD},
	/* 150	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9D, 0xB4, 0x9E, 0xAE, 0xC0,
	 0xB1, 0xC0, 0xCC, 0xC3, 0x97, 0xA4, 0x93, 0xB5, 0xBD, 0xB2,
	 0x00, 0xA9, 0x00, 0xAA, 0x00, 0xC8},
	/* 140	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xB7, 0xA2, 0xAC, 0xBE,
	 0xAE, 0xC1, 0xCE, 0xC5, 0x98, 0xA5, 0x94, 0xB5, 0xBD, 0xB2,
	 0x00, 0xA6, 0x00, 0xA7, 0x00, 0xC4},
	/* 130	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9A, 0xAD, 0x9B, 0xA7, 0xBB,
	 0xA9, 0xC2, 0xCF, 0xC7, 0x98, 0xA5, 0x94, 0xB6, 0xBE, 0xB3,
	 0x00, 0xA1, 0x00, 0xA3, 0x00, 0xBF},
	/* 120	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA0, 0xB2, 0xA0, 0xA5, 0xB9,
	 0xA7, 0xC1, 0xCF, 0xC6, 0x99, 0xA6, 0x95, 0xB7, 0xBF, 0xB4,
	 0x00, 0x9D, 0x00, 0x9E, 0x00, 0xBA},
	/* 110	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA6, 0xB7, 0xA7, 0xA0, 0xB5,
	 0xA2, 0xC3, 0xD0, 0xC8, 0x99, 0xA6, 0x96, 0xB9, 0xC1, 0xB5,
	 0x00, 0x99, 0x00, 0x9A, 0x00, 0xB4},
	/* 100	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x98, 0xA8, 0x99, 0xA6, 0xBA,
	 0xA7, 0xC4, 0xD2, 0xC9, 0x98, 0xA6, 0x96, 0xB8, 0xC1, 0xB5,
	 0x00, 0x94, 0x00, 0x95, 0x00, 0xAF},
	/* 90	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9E, 0xAD, 0x9F, 0xA1, 0xB6,
	 0xA2, 0xC7, 0xD4, 0xCB, 0x99, 0xA8, 0x98, 0xB9, 0xC1, 0xB5,
	 0x00, 0x90, 0x00, 0x90, 0x00, 0xA9},
	/* 80	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x91, 0x9C, 0x91, 0xA2, 0xB7,
	 0xA2, 0xC2, 0xD0, 0xC7, 0x9A, 0xA9, 0x9A, 0xBB, 0xC3, 0xB7,
	 0x00, 0x8A, 0x00, 0x8B, 0x00, 0xA3},
	/* 70	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9E, 0xA6, 0x9E, 0x9A, 0xB2,
	 0x9A, 0xC1, 0xCF, 0xC4, 0x99, 0xA9, 0x9A, 0xBD, 0xC5, 0xB9,
	 0x00, 0x85, 0x00, 0x85, 0x00, 0x9C},
	/* 60	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x8F, 0x94, 0x8F, 0x9A, 0xB3,
	 0x9B, 0xBF, 0xCD, 0xC2, 0x9A, 0xAB, 0x9C, 0xBC, 0xC5, 0xB9,
	 0x00, 0x7F, 0x00, 0x80, 0x00, 0x95},
	/* 50	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x96, 0x99, 0x96, 0x9A, 0xB4,
	 0x9B, 0xBD, 0xCC, 0xBF, 0x9C, 0xAD, 0x9F, 0xBC, 0xC5, 0xB9,
	 0x00, 0x79, 0x00, 0x79, 0x00, 0x8E},
	/* 40	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x8C, 0x8C, 0x8C, 0x99, 0xB1,
	 0x99, 0xB6, 0xC7, 0xB7, 0x9D, 0xB0, 0xA1, 0xBE, 0xC7, 0xBC,
	 0x00, 0x71, 0x00, 0x71, 0x00, 0x84},
	/* 30	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x71, 0x71, 0x71, 0xA6, 0xB9,
	 0xA7, 0xAF, 0xC2, 0xAF, 0x9E, 0xB2, 0xA3, 0xBC, 0xC5, 0xBA,
	 0x00, 0x68, 0x00, 0x69, 0x00, 0x7A},
	/* 20	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x80, 0x80, 0x80, 0xA7, 0xB1,
	 0xA8, 0xB3, 0xC6, 0xB3, 0x97, 0xAD, 0x9B, 0xBF, 0xC9, 0xBF,
	 0x00, 0x5C, 0x00, 0x5C, 0x00, 0x6C},
	/* 10	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x4C, 0x4C, 0x4C, 0x9B, 0x9B,
	 0x9B, 0xB8, 0xC6, 0xB9, 0x89, 0xA3, 0x8A, 0xC0, 0xCE, 0xC5,
	 0x00, 0x4C, 0x00, 0x4B, 0x00, 0x59}
};

static char pinkish_gamma_settings_nit[NUMBER_BRIGHTNESS_LEVELS][26] = {
	/* 300  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA0, 0xB2, 0x9E, 0xB3, 0xC6,
	 0xB9, 0xBB, 0xC5, 0xB8, 0x92, 0x9F, 0x8D, 0xAF, 0xB9, 0xAD,
	 0x00, 0xED, 0x00, 0xD1, 0x01, 0x0E},
	/* 290  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA0, 0xB2, 0x9E, 0xB5, 0xC7,
	 0xBB, 0xBA, 0xC4, 0xB7, 0x92, 0x9F, 0x8D, 0xAF, 0xB9, 0xAD,
	 0x00, 0xEA, 0x00, 0xCF, 0x01, 0x0B},
	/* 280  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xB5, 0xA1, 0xB3, 0xC5,
	 0xB8, 0xB9, 0xC4, 0xB7, 0x93, 0xA0, 0x8E, 0xAF, 0xB9, 0xAD,
	 0x00, 0xE7, 0x00, 0xCC, 0x01, 0x08},
	/* 270  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xB0, 0x9D, 0xB1, 0xC3,
	 0xB6, 0xBB, 0xC5, 0xB9, 0x92, 0x9F, 0x8D, 0xAF, 0xB9, 0xAC,
	 0x00, 0xE4, 0x00, 0xC9, 0x01, 0x04},
	/* 260  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xB0, 0x9D, 0xB3, 0xC5,
	 0xB8, 0xBA, 0xC5, 0xB8, 0x93, 0xA0, 0x8E, 0xAF, 0xB9, 0xAD,
	 0x00, 0xE1, 0x00, 0xC6, 0x01, 0x00},
	/* 250  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xB4, 0xA1, 0xB1, 0xC2,
	 0xB5, 0xBB, 0xC7, 0xBA, 0x91, 0x9F, 0x8C, 0xB0, 0xBA, 0xAE,
	 0x00, 0xDE, 0x00, 0xC4, 0x00, 0xFC},
	/* 240  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xB4, 0xA1, 0xB3, 0xC4,
	 0xB8, 0xBB, 0xC7, 0xBA, 0x92, 0xA0, 0x8D, 0xB0, 0xBA, 0xAE,
	 0x00, 0xDB, 0x00, 0xC1, 0x00, 0xF9},
	/* 230  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xAF, 0x9D, 0xB1, 0xC2,
	 0xB5, 0xBC, 0xC8, 0xBC, 0x92, 0x9F, 0x8D, 0xB0, 0xBA, 0xAE,
	 0x00, 0xD8, 0x00, 0xBE, 0x00, 0xF6},
	/* 220  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xAF, 0x9D, 0xB4, 0xC4,
	 0xB8, 0xBC, 0xC8, 0xBB, 0x93, 0xA0, 0x8E, 0xB1, 0xBB, 0xAE,
	 0x00, 0xD4, 0x00, 0xBB, 0x00, 0xF1},
	/* 210  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xB3, 0xA1, 0xB1, 0xC1,
	 0xB5, 0xBD, 0xC9, 0xBD, 0x92, 0xA0, 0x8D, 0xB1, 0xBA, 0xAE,
	 0x00, 0xD1, 0x00, 0xB9, 0x00, 0xEE},
	/* 200  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA7, 0xB6, 0xA5, 0xAF, 0xBF,
	 0xB2, 0xBD, 0xC9, 0xBD, 0x93, 0xA1, 0x8E, 0xB2, 0xBB, 0xAF,
	 0x00, 0xCD, 0x00, 0xB5, 0x00, 0xEA},
	/* 190  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xAE, 0x9D, 0xB2, 0xC1,
	 0xB5, 0xBE, 0xCB, 0xBF, 0x93, 0xA0, 0x8E, 0xB2, 0xBC, 0xB0,
	 0x00, 0xC9, 0x00, 0xB2, 0x00, 0xE5},
	/* 180  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xB1, 0xA1, 0xAF, 0xBE,
	 0xB2, 0xC0, 0xCD, 0xC1, 0x93, 0xA1, 0x8E, 0xB2, 0xBC, 0xAF,
	 0x00, 0xC6, 0x00, 0xAF, 0x00, 0xE1},
	/* 170  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA7, 0xB5, 0xA5, 0xAD, 0xBC,
	 0xAF, 0xBF, 0xCC, 0xC1, 0x94, 0xA2, 0x8F, 0xB3, 0xBC, 0xB0,
	 0x00, 0xC2, 0x00, 0xAC, 0x00, 0xDD},
	/* 160  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xAB, 0x9D, 0xAA, 0xB9,
	 0xAC, 0xC1, 0xCE, 0xC3, 0x94, 0xA2, 0x8F, 0xB3, 0xBC, 0xB0,
	 0x00, 0xBE, 0x00, 0xA9, 0x00, 0xD9},
	/* 150  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xAB, 0x9D, 0xAF, 0xBD,
	 0xB1, 0xBF, 0xCE, 0xC3, 0x94, 0xA2, 0x8F, 0xB4, 0xBD, 0xB1,
	 0x00, 0xBA, 0x00, 0xA5, 0x00, 0xD3},
	/* 140  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA3, 0xAF, 0xA1, 0xAD, 0xBA,
	 0xAE, 0xC1, 0xD0, 0xC5, 0x94, 0xA2, 0x8F, 0xB4, 0xBD, 0xB1,
	 0x00, 0xB6, 0x00, 0xA2, 0x00, 0xCF},
	/* 130  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9B, 0xA6, 0x9A, 0xA8, 0xB6,
	 0xA9, 0xC3, 0xD2, 0xC7, 0x94, 0xA3, 0x8F, 0xB5, 0xBE, 0xB2,
	 0x00, 0xB1, 0x00, 0x9E, 0x00, 0xCA},
	/* 120  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA1, 0xAC, 0xA0, 0xA6, 0xB3,
	 0xA7, 0xC2, 0xD1, 0xC7, 0x94, 0xA3, 0x90, 0xB6, 0xBE, 0xB2,
	 0x00, 0xAD, 0x00, 0x9A, 0x00, 0xC5},
	/* 110  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0xA7, 0xB1, 0xA6, 0xA2, 0xAF,
	 0xA1, 0xC4, 0xD3, 0xC9, 0x95, 0xA4, 0x91, 0xB7, 0xC0, 0xB4,
	 0x00, 0xA8, 0x00, 0x95, 0x00, 0xBF},
	/* 100  */
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x99, 0xA2, 0x98, 0xA7, 0xB3,
	 0xA7, 0xC5, 0xD4, 0xCA, 0x94, 0xA4, 0x91, 0xB7, 0xC0, 0xB3,
	 0x00, 0xA3, 0x00, 0x91, 0x00, 0xB9},
	/* 90	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xA7, 0x9E, 0xA3, 0xAE,
	 0xA1, 0xC7, 0xD6, 0xCC, 0x95, 0xA6, 0x93, 0xB8, 0xC1, 0xB4,
	 0x00, 0x9E, 0x00, 0x8C, 0x00, 0xB3},
	/* 80	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x92, 0x98, 0x91, 0xA3, 0xAF,
	 0xA2, 0xC3, 0xD1, 0xC7, 0x97, 0xA8, 0x95, 0xB9, 0xC3, 0xB6,
	 0x00, 0x98, 0x00, 0x86, 0x00, 0xAC},
	/* 70	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x9F, 0xA3, 0x9E, 0x9B, 0xA9,
	 0x9A, 0xC2, 0xCF, 0xC5, 0x96, 0xA8, 0x96, 0xBB, 0xC5, 0xB8,
	 0x00, 0x92, 0x00, 0x81, 0x00, 0xA5},
	/* 60	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x8F, 0x92, 0x8F, 0x9B, 0xA9,
	 0x9A, 0xC0, 0xCC, 0xC2, 0x98, 0xAA, 0x98, 0xBB, 0xC4, 0xB7,
	 0x00, 0x8B, 0x00, 0x7B, 0x00, 0x9E},
	/* 50	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x96, 0x98, 0x96, 0x9C, 0xAA,
	 0x9A, 0xBE, 0xC9, 0xBF, 0x9A, 0xAD, 0x9C, 0xBA, 0xC4, 0xB7,
	 0x00, 0x85, 0x00, 0x75, 0x00, 0x96},
	/* 40	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x8C, 0x8C, 0x8C, 0x9A, 0xA8,
	 0x99, 0xB7, 0xC1, 0xB7, 0x9C, 0xB1, 0xA0, 0xBC, 0xC5, 0xB8,
	 0x00, 0x7B, 0x00, 0x6D, 0x00, 0x8B},
	/* 30	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x71, 0x71, 0x71, 0xA8, 0xB2,
	 0xA6, 0xB0, 0xBB, 0xAF, 0x9E, 0xB3, 0xA3, 0xB9, 0xC3, 0xB5,
	 0x00, 0x72, 0x00, 0x65, 0x00, 0x81},
	/* 20	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x80, 0x80, 0x80, 0xA8, 0xAE,
	 0xA7, 0xB4, 0xBF, 0xB3, 0x98, 0xAB, 0x9C, 0xBC, 0xC8, 0xBC,
	 0x00, 0x64, 0x00, 0x58, 0x00, 0x71},
	/* 10	*/
	{0xFA, 0x02, 0x51, 0x39, 0x55, 0x4C, 0x4C, 0x4C, 0x9B, 0x9B,
	 0x9B, 0xB9, 0xC1, 0xB8, 0x8B, 0x9A, 0x8A, 0xC1, 0xD1, 0xC6,
	 0x00, 0x51, 0x00, 0x46, 0x00, 0x5C}
};

static char gamma_set_update[2] = {0xfa, 0x03}; /* DTYPE_DCS_WRITE1 */

static struct dsi_cmd_desc smd_qhd_429_cmds_2[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
		sizeof(def_gamma_settings_nit[0]), def_gamma_settings_nit[0]},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
		sizeof(gamma_set_update), gamma_set_update},
};
/* [3] */
static char panel_condition_set[14] = {
	0xF8,
	0x27, 0x27, 0x08, 0x08, 0x4E, 0xAA, 0x5E, 0x8A,
	0x10, 0x3F, 0x10, 0x10, 0x00,
};
static struct dsi_cmd_desc smd_qhd_429_cmds_3[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
		sizeof(panel_condition_set), panel_condition_set},
};
/* [4] */
static char etc_condition_set2_1[4] = {
	0xF6, 0x00, 0x84, 0x09,
};
static char etc_condition_set2_2[2] = { /* DTYPE_DCS_WRITE1 */
	0xB0, 0x09,
};
static char etc_condition_set2_3[2] = { /* DTYPE_DCS_WRITE1 */
	0xD5, 0x64,
};
static char etc_condition_set2_4[2] = { /* DTYPE_DCS_WRITE1 */
	0xB0, 0x0B,
};
static char etc_condition_set2_5[4] = {
	0xD5, 0xA4, 0x7E, 0x20,
};
static char etc_condition_set2_6[2] = { /* DTYPE_DCS_WRITE1 */
	0xB0, 0x08,
};
static char etc_condition_set2_7[2] = { /* DTYPE_DCS_WRITE1 */
	0xFD, 0xF8,
};
static char etc_condition_set2_8[2] = { /* DTYPE_DCS_WRITE1 */
	0xB0, 0x04,
};
static char etc_condition_set2_9[2] = { /* DTYPE_DCS_WRITE1 */
	0xF2, 0x4D,
};
static char etc_condition_set2_A[2] = { /* DTYPE_DCS_WRITE1 */
	0xB0, 0x05,
};
static char etc_condition_set2_B[2] = { /* DTYPE_DCS_WRITE1 */
	0xFD, 0x1F,
};
static char etc_condition_set2_C[4] = {
	0xB1, 0x01, 0x00, 0x16,
};
static struct dsi_cmd_desc smd_qhd_429_cmds_4[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_1), etc_condition_set2_1},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_2), etc_condition_set2_2},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_3), etc_condition_set2_3},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_4), etc_condition_set2_4},
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_5), etc_condition_set2_5},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_6), etc_condition_set2_6},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_7), etc_condition_set2_7},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_8), etc_condition_set2_8},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_9), etc_condition_set2_9},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_A), etc_condition_set2_A},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_B), etc_condition_set2_B},
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(etc_condition_set2_C), etc_condition_set2_C},
};
static struct dsi_cmd_desc smd_qhd_429_cmds_5[] = {
	{DTYPE_DCS_WRITE, 1, 0, 0, 120,
			sizeof(exit_sleep), exit_sleep}
};

/* win size = 540 * 960 */
static char mem_window_set_1[5] = { /* DTYPE_DCS_LWRITE */
	0x2A, 0x00, 0x1E, 0x02, 0x39
};
static char mem_window_set_2[5] = { /* DTYPE_DCS_LWRITE */
	0x2B, 0x00, 0x00, 0x03, 0xBF
};
static char vinit_set[2] = { /* DTYPE_DCS_WRITE1 */
	0xD1, 0x8A
};
static struct dsi_cmd_desc smd_qhd_429_cmds_6[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(mem_window_set_1), mem_window_set_1},
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
			sizeof(mem_window_set_2), mem_window_set_2},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
			sizeof(vinit_set), vinit_set},
};
/* [7] */
static char acl_default_set[29] = { /* 70% */
	0xC1,
	0x47, 0x53, 0x13, 0x53,
	0x00, 0x00, 0x01, 0xDF,
	0x00, 0x00, 0x03, 0x1F,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x01, 0x02, 0x03,
	0x07, 0x0E, 0x14, 0x1C,
	0x24, 0x2D, 0x2D, 0x00,
};

static char ACL_enable_disable_settings[2] = {0xc0, 0x00};

static struct dsi_cmd_desc smd_qhd_429_cmds_7[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
		sizeof(acl_default_set), acl_default_set},
	{DTYPE_DCS_WRITE1, 1, 0, 0, DEFAULT_DELAY,
		sizeof(ACL_enable_disable_settings),
			ACL_enable_disable_settings},
};

static struct dsi_cmd_desc acl_enable_disable[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
		sizeof(ACL_enable_disable_settings),
			ACL_enable_disable_settings}
};

/* default elvss set, update based on 0xD4 */
static char elvss_output_set[5] = {
	0xB2,
	0x08, 0x08, 0x08, 0x08,
};
static struct dsi_cmd_desc elvss_set_cmd[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, DEFAULT_DELAY,
		sizeof(elvss_output_set), elvss_output_set}
};

static char d4_val[2] = {0xD4, 0x00};
static struct dsi_cmd_desc get_d4_cmd = {
	DTYPE_DCS_READ, 1, 0, 1, DEFAULT_DELAY, sizeof(d4_val), d4_val
};

static u8 elvss_value = 0x08;
static u8 white_pt_adj = 0xff;

/*
 * Framework brightness <--> panel nit mapping table
 * Kernel brigheness is (framework brightness) / 2,
 * So maximum is 127(255/2).
 */
static u8 backlight_curve_mapping[FB_BACKLIGHT_LEVELS] = {
	/* Framework level / 2: from 0 to 15 */
	0,   0,  0,  0,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  3,  3,
	/* 16 to 31 */
	3,   3,  4,  4,  4,  4,  5,  5,  5,  5,  6,  6,  6,  6,  6,  7,
	/* 32 to 47 */
	7,   7,  7,  8,  8,  8,  8,  9,  9,  9,  9, 10, 10, 10, 10, 10,
	/* 48 to 63 */
	11, 11, 11, 11, 12, 12, 12, 12, 13, 13, 13, 13, 14, 14, 14, 14,
	/* 64 to 79 */
	14, 15, 15, 15, 15, 16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18,
	/* 80 to 95 */
	18, 18, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 22, 22,
	/* 96 to 111 */
	22, 22, 22, 23, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 26,
	/* 112 to 127 */
	26, 26, 26, 26, 27, 27, 27, 27, 28, 28, 28, 28, 29, 29, 29, 29
};

static void enable_acl(struct msm_fb_data_type *mfd)
{
	struct dsi_buf *dsi_tx_buf;
	/* Write the value only if the display is enable and powerd on */
	if ((mfd->op_enable != 0) && (mfd->panel_power_on != 0)) {
		dsi_tx_buf = mot_panel->mot_tx_buf;
		mutex_lock(&mfd->dma->ov_mutex);
		/*
		 * Todo: add 50us delay between frame and cmd or between frames
		 */
		mipi_mot_mipi_busy_wait(mfd);
		mipi_set_tx_power_mode(0);
		ACL_enable_disable_settings[1] = mot_panel->acl_enabled;
		mipi_dsi_cmds_tx(mfd, dsi_tx_buf, acl_enable_disable,
					ARRAY_SIZE(acl_enable_disable));
		mutex_unlock(&mfd->dma->ov_mutex);
	}
}

static struct dsi_cmd_desc set_brightness_cmds[] = {
	{DTYPE_DCS_LWRITE, 1, 0, 0, 0,
		sizeof(def_gamma_settings_nit[0]), def_gamma_settings_nit[0]},
	{DTYPE_DCS_WRITE1, 1, 0, 0, 0,
		sizeof(gamma_set_update), gamma_set_update}
};

static char *getGamma(int gammaIdx)
{
	switch (white_pt_adj) {
	case 6:
	case 8:
	case 9:
		return greenish_gamma_settings_nit[gammaIdx];
	case 1:
	case 2:
	case 4:
		return pinkish_gamma_settings_nit[gammaIdx];
	default:
		return def_gamma_settings_nit[gammaIdx];
	}
}

static void mipi_mot_get_mtpset4(struct msm_fb_data_type *mfd)
{
	struct dsi_cmd_desc *cmd;
	struct dsi_buf *rp, *tp;
	uint32 *lp;
	int ret;
	static int d4_value = INVALID_VALUE;

	if (d4_value == INVALID_VALUE) {
		if (mot_panel == NULL) {
			pr_err("%s: invalid mot_panel\n", __func__);
			return;
		}
		tp = mot_panel->mot_tx_buf;
		rp = mot_panel->mot_rx_buf;
		mipi_dsi_buf_init(rp);
		mipi_dsi_buf_init(tp);

		cmd =  &get_d4_cmd;
		ret = mipi_dsi_cmds_rx(mfd, tp, rp, cmd, 2);
		if (!ret)
			pr_err("%s: failed to read D4h\n", __func__);
		else {
			lp = (uint32 *)rp->data;
			d4_value  = (int)*lp;

			elvss_value = d4_value & 0x3F;
			if (mipi_mot_get_controller_ver(mfd) >= 1)
				white_pt_adj = (d4_value & 0xF000) >> 12;

			pr_info("%s: elvss = 0x%2x, white_pt_adj = 0x%02x\n",
				 __func__, elvss_value, white_pt_adj);
		}
	}
}

static int panel_enable(struct msm_fb_data_type *mfd)
{
	struct dsi_buf *dsi_tx_buf;
	int i;
	int idx;
	static bool first_boot = true;

	if (mot_panel == NULL) {
		pr_err("%s: Invalid mot_panel\n", __func__);
		return -EINVAL;
	}

	if (first_boot) {
		/*
		 * Kernel bootup. Set it to default nit which should
		 * be same with it in bootloader.
		 */
		idx = NUMBER_BRIGHTNESS_LEVELS - DEFAULT_BRIGHTNESS_LEVELS - 1;
		first_boot = false;
	} else
		idx = NUMBER_BRIGHTNESS_LEVELS - mfd->bl_level - 1;

	if (idx < 0)
		idx = 0;
	if (idx > NUMBER_BRIGHTNESS_LEVELS - 1)
		idx = NUMBER_BRIGHTNESS_LEVELS - 1;

	dsi_tx_buf = mot_panel->mot_tx_buf;
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_1,
			ARRAY_SIZE(smd_qhd_429_cmds_1));

	/* Read D4h for elvss and apply gamma */
	mipi_mot_get_mtpset4(mfd);

	/* gamma */
	smd_qhd_429_cmds_2[0].payload = getGamma(idx);
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_2,
			ARRAY_SIZE(smd_qhd_429_cmds_2));

	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_3,
			ARRAY_SIZE(smd_qhd_429_cmds_3));
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_4,
			ARRAY_SIZE(smd_qhd_429_cmds_4));

	/* elvss */
	for (i = 1; i < 5; i++)
		elvss_output_set[i] = elvss_value;
	if (mot_panel->elvss_tth_support_present &&
		mot_panel->elvss_tth_status)
		for (i = 1; i < 5; i++)
			elvss_output_set[i] = elvss_value + 0xF;

	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, elvss_set_cmd,
		ARRAY_SIZE(elvss_set_cmd));

	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_5,
			ARRAY_SIZE(smd_qhd_429_cmds_5));
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_6,
			ARRAY_SIZE(smd_qhd_429_cmds_6));
	/* acl */
	ACL_enable_disable_settings[1] = mot_panel->acl_enabled;
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, smd_qhd_429_cmds_7,
			ARRAY_SIZE(smd_qhd_429_cmds_7));

	return 0;
}

static int panel_disable(struct msm_fb_data_type *mfd)
{
	struct dsi_buf *dsi_tx_buf;

	if (mot_panel == NULL) {
		pr_err("%s: Invalid mot_panel\n", __func__);
		return -EINVAL;
	}

	dsi_tx_buf =  mot_panel->mot_tx_buf;
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, display_off_cmds,
			ARRAY_SIZE(display_off_cmds));

	return 0;
}

static int is_valid_manufacture_id(struct msm_fb_data_type *mfd, u8 id)
{
	return id == 0x22;
}

static void panel_set_backlight(struct msm_fb_data_type *mfd)
{

	struct mipi_panel_info *mipi;
	static int bl_level_old;
	int idx = 0;
	struct dsi_buf *dsi_tx_buf;

	pr_debug("%s(bl_level=%d)\n", __func__, (s32)mfd->bl_level);

	mipi  = &mfd->panel_info.mipi;
	dsi_tx_buf =  mot_panel->mot_tx_buf;

	if (!mfd->panel_power_on)
		return;

	if (bl_level_old == mfd->bl_level)
		return;

	/* should already be in panel bl range */
	idx = NUMBER_BRIGHTNESS_LEVELS - mfd->bl_level - 1;

	if (idx < 0)
		idx = 0;
	if (idx > NUMBER_BRIGHTNESS_LEVELS - 1)
		idx = NUMBER_BRIGHTNESS_LEVELS - 1;

	pr_debug("%s(idx=%d)\n", __func__, (s32)idx);
	set_brightness_cmds[0].payload = getGamma(idx);

	mutex_lock(&mfd->dma->ov_mutex);
	/* Todo: add 50us delay between frame and cmd or between frames */
	mipi_mot_mipi_busy_wait(mfd);

	mipi_set_tx_power_mode(0);
	mipi_dsi_cmds_tx(mfd, dsi_tx_buf, set_brightness_cmds,
			ARRAY_SIZE(set_brightness_cmds));

	bl_level_old = mfd->bl_level;
	mutex_unlock(&mfd->dma->ov_mutex);

	pr_debug("%s(%d) completed\n", __func__, (s32)mfd->bl_level);

	return;
}

static void panel_set_backlight_curve(struct msm_fb_data_type *mfd)
{
	struct fb_info *fbi;
	int i;

	pr_debug("panel backlight curve is called.\n");
	fbi = mfd->fbi;
	if(!fbi) {
		pr_warning("%s: fb_info is null!\n", __FUNCTION__);
		return;
	}

	for (i = 0; i < FB_BACKLIGHT_LEVELS; i++) {
		fbi->bl_curve[i] = backlight_curve_mapping[i];
	}
}

static int __init mipi_cmd_mot_smd_qhd_429_init(void)
{
	int ret;
	struct msm_panel_info *pinfo;

	pr_debug("%s\n", __func__);

	/* comment it out to force to use this panel */
	if (msm_fb_detect_client("mipi_mot_cmd_smd_qhd_429"))
		return 0;

	mot_panel = mipi_mot_get_mot_panel();
	if (mot_panel == NULL) {
		pr_err("%s:get mot_panel failed\n", __func__);
		return -EINVAL;  /*TODO.. need to fix this */
	}

	pinfo = &mot_panel->pinfo;

	pinfo->xres = 540;
	pinfo->yres = 960;
	pinfo->type = MIPI_CMD_PANEL;
	pinfo->pdest = DISPLAY_1;
	pinfo->wait_cycle = 0;
	pinfo->bpp = 24;
	pinfo->lcdc.h_back_porch = 32;
	pinfo->lcdc.h_front_porch = 32;
	pinfo->lcdc.h_pulse_width = 32;
	pinfo->lcdc.v_back_porch = 2;
	pinfo->lcdc.v_front_porch = 2;
	pinfo->lcdc.v_pulse_width = 2;
	pinfo->lcdc.border_clr = 0;	/* blk */
	pinfo->lcdc.underflow_clr = 0xff;	/* blue */
	pinfo->lcdc.hsync_skew = 0;
	pinfo->bl_max = NUMBER_BRIGHTNESS_LEVELS - 1;
	pinfo->bl_min = 0;
	pinfo->fb_num = 2;
	pinfo->clk_rate = 460000000;
	pinfo->physical_width_mm = 54;
	pinfo->physical_height_mm = 95;

	pinfo->lcd.vsync_enable = TRUE;
	pinfo->lcd.hw_vsync_mode = TRUE;
	pinfo->lcd.v_back_porch = 2;	/* TODO: check later */
	pinfo->lcd.v_front_porch = 2;
	pinfo->lcd.v_pulse_width = 2;
	pinfo->lcd.refx100 = 6000; /* adjust refx100 to prevent tearing */

	pinfo->mipi.mode = DSI_CMD_MODE;
	pinfo->mipi.dst_format = DSI_CMD_DST_FORMAT_RGB888;
	pinfo->mipi.vc = 0;
	pinfo->mipi.rgb_swap = DSI_RGB_SWAP_RGB;
	pinfo->mipi.data_lane0 = TRUE;
	pinfo->mipi.data_lane1 = TRUE;
	pinfo->mipi.t_clk_post = 0x19;  /* DSI_CLKOUT_TIMING_CTRL >>8 */
	pinfo->mipi.t_clk_pre = 0x2f;	/* DSI_CLKOUT_TIMING_CTRL && 0XFF */
	pinfo->mipi.stream = 0;	/* dma_p */
	pinfo->mipi.mdp_trigger = DSI_CMD_TRIGGER_NONE;
	pinfo->mipi.dma_trigger = DSI_CMD_TRIGGER_SW;
	pinfo->mipi.te_sel = 1;
	pinfo->mipi.interleave_max = 1;
	pinfo->mipi.insert_dcs_cmd = TRUE;
	pinfo->mipi.wr_mem_continue = 0x3c;
	pinfo->mipi.wr_mem_start = 0x2c;
	pinfo->mipi.dsi_phy_db = &dsi_cmd_mode_phy_db;
	pinfo->mipi.tx_eot_append = 0x01;
	pinfo->mipi.rx_eot_ignore = 0;

	mot_panel->acl_support_present = TRUE;
	mot_panel->acl_enabled = FALSE; /* By default the ACL is disbled. */

	mot_panel->elvss_tth_support_present = TRUE;

	mot_panel->panel_enable = panel_enable;
	mot_panel->panel_disable = panel_disable;
	mot_panel->set_backlight = panel_set_backlight;
	mot_panel->set_backlight_curve = panel_set_backlight_curve;
	mot_panel->enable_acl = enable_acl;
	mot_panel->esd_enabled = true;
	mot_panel->is_valid_manufacture_id = is_valid_manufacture_id;

	ret = mipi_mot_device_register(pinfo, MIPI_DSI_PRIM,
						MIPI_DSI_PANEL_HD);
	if (ret)
		pr_err("%s: failed to register device!\n", __func__);

	pr_debug("%s device registered\n", __func__);

	return ret;
}

module_init(mipi_cmd_mot_smd_qhd_429_init);
